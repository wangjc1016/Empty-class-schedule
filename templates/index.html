<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç©ºè¯¾è¡¨</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: white;
      text-align: center;
    }
    table {
      width: 90%;
      margin: auto;
      border-collapse: collapse;
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 10px;
    }
    th {
      background: rgba(0, 0, 0, 0.3);
    }
    button {
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #2196F3, #21CBF3);
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border-radius: 5px;
      transition: 0.3s;
    }
    button:hover {
      background: linear-gradient(45deg, #21CBF3, #2196F3);
    }
    .week-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .week-header button {
      padding: 10px 20px;
      background: linear-gradient(45deg, #FF4081, #F50057);
      border: none;
      color: white;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    .week-header button:hover {
      background: linear-gradient(45deg, #F50057, #FF4081);
    }
    .week-title {
      font-size: 20px;
      font-weight: bold;
    }
    #exportExcelBtn {
      margin: 20px;
      padding: 10px 20px;
      background: linear-gradient(45deg, #4CAF50, #8BC34A);
      border: none;
      color: white;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    #exportExcelBtn:hover {
      background: linear-gradient(45deg, #8BC34A, #4CAF50);
    }
    /* è¿›åº¦æ¡æ ·å¼ */
    #progressContainer {
      display: none;
      width: 90%;
      margin: 20px auto;
      background: #555;
      border-radius: 5px;
      overflow: hidden;
    }
    #progressBar {
      width: 0%;
      height: 20px;
      background: #4CAF50;
    }
    /* Modal æ ·å¼ */
    #modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #modalContent {
      background: #fff;
      color: #000;
      padding: 20px;
      border-radius: 10px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      text-align: left;
      position: relative;
    }
    #modalClose {
      cursor: pointer;
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 24px;
      font-weight: bold;
    }
  </style>
  <!-- å¼•å…¥ ICS åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
  <!-- å¼•å…¥ SheetJS åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let currentWeekOffset = 0;
    let globalFreeTimes = {};
    let globalBusyTimes = {};
    let globalCSVData = null; // ä¿å­˜ä¸Šä¼ çš„ CSV åŸå§‹æ•°æ®
    let globalStudentData = []; // ä¿å­˜æ¯ä¸ªåŒå­¦çš„ ICS äº‹ä»¶æ•°æ®

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('uploadCSV').addEventListener('change', function(event) {
        let file = event.target.files[0];
        if (file) {
          let reader = new FileReader();
          reader.onload = function(e) {
            let csvData = e.target.result;
            globalCSVData = csvData;
            processCSV(csvData);
          };
          reader.readAsText(file);
        }
      });

      document.getElementById('prevWeek').addEventListener('click', function() {
        currentWeekOffset--;
        if (globalStudentData.length > 0) {
          recalcSchedule();
        }
      });
      document.getElementById('nextWeek').addEventListener('click', function() {
        currentWeekOffset++;
        if (globalStudentData.length > 0) {
          recalcSchedule();
        }
      });

      document.getElementById('exportExcelBtn').addEventListener('click', exportExcel);

      // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
      document.getElementById('modalClose').addEventListener('click', function() {
        document.getElementById('modalOverlay').style.display = 'none';
      });
      // ç‚¹å‡»é®ç½©åŒºåŸŸå…³é—­å¼¹çª—
      document.getElementById('modalOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });
    });

    // ICS æ•°æ®è¯·æ±‚ï¼Œé€šè¿‡åç«¯ä»£ç†é¿å…è·¨åŸŸ
    async function fetchICS(url) {
      try {
        let proxyUrl = `/proxy_ics?url=${encodeURIComponent(url)}`;
        let response = await fetch(proxyUrl);
        let text = await response.text();
        let jcalData = ICAL.parse(text);
        let comp = new ICAL.Component(jcalData);
        let vevents = comp.getAllSubcomponents('vevent');
        return vevents.map(event => {
          let vevent = new ICAL.Event(event);
          return {
            start: vevent.startDate.toJSDate(),
            end: vevent.endDate.toJSDate(),
            summary: vevent.summary || ""
          };
        });
      } catch (error) {
        console.error('è·å–ICSæ•°æ®å¤±è´¥:', error);
        return [];
      }
    }

    // CSV å¯¼å…¥æ—¶è°ƒç”¨ï¼Œè·å–æ‰€æœ‰åŒå­¦çš„ ICS æ•°æ®å¹¶å­˜å‚¨åˆ° globalStudentData ä¸­ï¼ŒåŒæ—¶æ˜¾ç¤ºè¿›åº¦æ¡
    async function processCSV(csvData) {
      // æ˜¾ç¤ºè¿›åº¦æ¡
      let progressContainer = document.getElementById("progressContainer");
      let progressBar = document.getElementById("progressBar");
      progressContainer.style.display = "block";
      progressBar.style.width = "0%";
      
      // æ”¯æŒå¤šå¹³å°æ¢è¡Œç¬¦ï¼Œå¹¶è¿‡æ»¤ç©ºè¡Œ
      let rows = csvData.split(/\r?\n/).filter(row => row.trim() !== '');
      // è‹¥ç¬¬ä¸€è¡ŒåŒ…å«æ ‡é¢˜åˆ™è·³è¿‡
      if (rows.length && (rows[0].toLowerCase().includes("name") || rows[0].includes("å§“å"))) {
        rows = rows.slice(1);
      }
      
      globalStudentData = []; // æ¸…ç©ºä¹‹å‰çš„æ•°æ®
      let total = rows.length;
      for (let i = 0; i < total; i++) {
        let row = rows[i];
        let parts = row.split(',');
        if (parts.length < 2) continue;
        let name = parts[0].trim();
        let icsUrl = parts[1].trim();
        if (!name || !icsUrl) continue;
        let events = await fetchICS(icsUrl);
        globalStudentData.push({ name, events });
        // æ›´æ–°è¿›åº¦æ¡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        progressBar.style.width = ((i + 1) / total * 100) + "%";
      }
      // å®Œæˆåéšè—è¿›åº¦æ¡
      setTimeout(() => {
        progressContainer.style.display = "none";
      }, 500);
      // è®¡ç®—å¹¶æ˜¾ç¤ºå½“å‰å‘¨çš„è¯¾è¡¨
      recalcSchedule();
    }

    // æ ¹æ® globalStudentData å’Œå½“å‰å‘¨æ¬¡é‡æ–°è®¡ç®—ç©ºé—²ä¸æœ‰è¯¾æƒ…å†µ
    function recalcSchedule() {
      // åˆå§‹åŒ–å·¥ä½œæ—¥ï¼ˆ0: å‘¨ä¸€ ... 4: å‘¨äº”ï¼‰æ¯ä¸ªæ—¶æ®µçš„ç©ºé—²å’Œæœ‰è¯¾æ•°ç»„
      let freeTimes = {};
      let busyTimes = {};
      for (let i = 0; i < 5; i++) {
        freeTimes[i] = Array(13).fill(null).map(() => []);
        busyTimes[i] = Array(13).fill(null).map(() => []);
      }
      const scheduleTimes = [
        "08:05", "08:55", "10:00", "10:50", "11:40",
        "13:30", "14:20", "15:15", "16:05",
        "18:30", "19:20", "20:10", "21:00"
      ];
      
      // æ ¹æ® currentWeekOffset è®¡ç®—å½“å‰å‘¨çš„å‘¨ä¸€å’Œå‘¨äº”ï¼ˆè°ƒæ•´æ—¶åˆ†ç§’ï¼‰
      let targetDate = new Date();
      targetDate.setDate(targetDate.getDate() + currentWeekOffset * 7);
      let monday = new Date(targetDate);
      let dayOfWeek = monday.getDay();
      let diff = (dayOfWeek === 0 ? -6 : 1 - dayOfWeek);
      monday.setDate(monday.getDate() + diff);
      monday.setHours(0, 0, 0, 0);
      
      let friday = new Date(monday);
      friday.setDate(monday.getDate() + 4);
      friday.setHours(23, 59, 59, 999);
      
      // å¯¹äº globalStudentData ä¸­çš„æ¯ä¸ªåŒå­¦ï¼Œç»Ÿè®¡å…¶å½“å‰å‘¨å†…çš„äº‹ä»¶
      globalStudentData.forEach(student => {
        let name = student.name;
        let events = student.events;
        // å°†è¯¥åŒå­¦çš„äº‹ä»¶æŒ‰å·¥ä½œæ—¥åˆ†ç»„ï¼ˆ0: å‘¨ä¸€ ... 4: å‘¨äº”ï¼‰
        let eventsByDay = { 0: [], 1: [], 2: [], 3: [], 4: [] };
        events.forEach(event => {
          let eventDate = event.start;
          if (eventDate < monday || eventDate > friday) return;
          let jsDay = eventDate.getDay();
          let dayIndex;
          if (jsDay === 1) dayIndex = 0;
          else if (jsDay === 2) dayIndex = 1;
          else if (jsDay === 3) dayIndex = 2;
          else if (jsDay === 4) dayIndex = 3;
          else if (jsDay === 5) dayIndex = 4;
          else return;
          eventsByDay[dayIndex].push(event);
        });
        
        // é’ˆå¯¹å½“å‰å‘¨æ¯ä¸€å¤©æ¯ä¸ªé¢„è®¾æ—¶æ®µåˆ¤æ–­è¯¥åŒå­¦æ˜¯å¦ç©ºé—²æˆ–æœ‰è¯¾
        for (let day = 0; day < 5; day++) {
          scheduleTimes.forEach((slot, index) => {
            let [h, m] = slot.split(':').map(Number);
            let slotMinutes = h * 60 + m;
            // åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶è¦†ç›–è¯¥æ—¶æ®µ
            let overlappingEvents = eventsByDay[day].filter(event => {
              let eventStart = event.start.getHours() * 60 + event.start.getMinutes();
              let eventEnd = event.end.getHours() * 60 + event.end.getMinutes();
              return (slotMinutes >= eventStart && slotMinutes < eventEnd);
            });
            if (overlappingEvents.length === 0) {
              freeTimes[day][index].push(name);
            } else {
              overlappingEvents.forEach(ev => {
                busyTimes[day][index].push({ name: name, course: ev.summary });
              });
            }
          });
        }
      });
      
      globalFreeTimes = freeTimes;
      globalBusyTimes = busyTimes;
      renderTable(freeTimes, busyTimes);
    }

    function renderTable(freeTimes, busyTimes) {
      // æ ¹æ® currentWeekOffset è®¡ç®—å½“å‰å‘¨çš„å‘¨ä¸€å’Œå‘¨äº”ï¼ˆè°ƒæ•´æ—¶åˆ†ç§’ï¼‰
      let targetDate = new Date();
      targetDate.setDate(targetDate.getDate() + currentWeekOffset * 7);
      let monday = new Date(targetDate);
      let dayOfWeek = monday.getDay();
      let diff = (dayOfWeek === 0 ? -6 : 1 - dayOfWeek);
      monday.setDate(monday.getDate() + diff);
      monday.setHours(0, 0, 0, 0);
      
      let friday = new Date(monday);
      friday.setDate(monday.getDate() + 4);
      friday.setHours(23, 59, 59, 999);
      
      // æ›´æ–°æ ‡é¢˜ï¼šæ˜¾ç¤ºå½“å‰å·¥ä½œæ—¥çš„æ—¥æœŸèŒƒå›´
      let options = { month: 'numeric', day: 'numeric' };
      document.getElementById("weekTitle").textContent = `å½“å‰å‘¨: ${monday.toLocaleDateString('zh-CN', options)} - ${friday.toLocaleDateString('zh-CN', options)}`;

      let table = document.getElementById("scheduleTable");
      table.innerHTML = "";
      // æ„é€ è¡¨å¤´ï¼šç¬¬ä¸€åˆ—ä¸ºâ€œèŠ‚æ¬¡â€ï¼Œåç»­ä¸ºå‘¨ä¸€è‡³å‘¨äº”
      let headerRow = document.createElement("tr");
      headerRow.innerHTML = `<th>èŠ‚æ¬¡</th>`;
      const weekdayNames = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”"];
      for (let i = 0; i < 5; i++) {
        let dayDate = new Date(monday);
        dayDate.setDate(monday.getDate() + i);
        let dateStr = dayDate.toLocaleDateString('zh-CN', options);
        headerRow.innerHTML += `<th>${weekdayNames[i]}<br>${dateStr}</th>`;
      }
      table.appendChild(headerRow);
      
      const scheduleTimes = [
        "08:05", "08:55", "10:00", "10:50", "11:40",
        "13:30", "14:20", "15:15", "16:05",
        "18:30", "19:20", "20:10", "21:00"
      ];
      scheduleTimes.forEach((time, index) => {
        let row = document.createElement("tr");
        let timeCell = document.createElement("td");
        timeCell.textContent = `${index + 1} (${time})`;
        row.appendChild(timeCell);
        
        for (let day = 0; day < 5; day++) {
          let cell = document.createElement("td");
          let btn = document.createElement("button");
          let freePeople = freeTimes[day][index] || [];
          let busyPeople = busyTimes[day][index] || [];
          btn.textContent = `ç©ºé—² ${freePeople.length} / æœ‰è¯¾ ${busyPeople.length}`;
          btn.onclick = function() {
            showModal(day, index, freePeople, busyPeople);
          };
          cell.appendChild(btn);
          row.appendChild(cell);
        }
        table.appendChild(row);
      });
    }

    function showModal(day, slotIndex, freePeople, busyPeople) {
      let modalBody = document.getElementById("modalBody");
      let scheduleTimes = [
        "08:05", "08:55", "10:00", "10:50", "11:40",
        "13:30", "14:20", "15:15", "16:05",
        "18:30", "19:20", "20:10", "21:00"
      ];
      let content = `<h2>${scheduleTimes[slotIndex]}</h2>`;
      content += `<h3>ç©ºé—²</h3>`;
      if (freePeople.length > 0) {
        content += `<ul>`;
        freePeople.forEach(name => {
          content += `<li>${name}</li>`;
        });
        content += `</ul>`;
      } else {
        content += `<p>æ— </p>`;
      }
      content += `<h3>æœ‰è¯¾</h3>`;
      if (busyPeople.length > 0) {
        content += `<ul>`;
        busyPeople.forEach(item => {
          content += `<li>${item.name} - ${item.course}</li>`;
        });
        content += `</ul>`;
      } else {
        content += `<p>æ— </p>`;
      }
      modalBody.innerHTML = content;
      document.getElementById("modalOverlay").style.display = 'flex';
    }

    // å¯¼å‡º Excel åŠŸèƒ½
    function exportExcel() {
      // æ ¹æ® currentWeekOffset è®¡ç®—å½“å‰å‘¨çš„å‘¨ä¸€å’Œå‘¨äº”ï¼ˆè°ƒæ•´æ—¶åˆ†ç§’ï¼‰
      let targetDate = new Date();
      targetDate.setDate(targetDate.getDate() + currentWeekOffset * 7);
      let monday = new Date(targetDate);
      let dayOfWeek = monday.getDay();
      let diff = (dayOfWeek === 0 ? -6 : 1 - dayOfWeek);
      monday.setDate(monday.getDate() + diff);
      monday.setHours(0, 0, 0, 0);
      let friday = new Date(monday);
      friday.setDate(monday.getDate() + 4);
      friday.setHours(23, 59, 59, 999);
      
      // æ„é€  Excel æ•°æ®ï¼ˆäºŒç»´æ•°ç»„ï¼‰
      let options = { month: 'numeric', day: 'numeric' };
      let header = ["èŠ‚æ¬¡"];
      const weekdayNames = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”"];
      for (let i = 0; i < 5; i++) {
        let dayDate = new Date(monday);
        dayDate.setDate(monday.getDate() + i);
        header.push(`${weekdayNames[i]} (${dayDate.toLocaleDateString('zh-CN', options)})`);
      }
      let data = [];
      data.push(header);
      
      const scheduleTimes = [
        "08:05", "08:55", "10:00", "10:50", "11:40",
        "13:30", "14:20", "15:15", "16:05",
        "18:30", "19:20", "20:10", "21:00"
      ];
      
      for (let i = 0; i < scheduleTimes.length; i++) {
        let row = [];
        row.push(`${i+1} (${scheduleTimes[i]})`);
        for (let day = 0; day < 5; day++) {
          let freePeople = (globalFreeTimes[day] && globalFreeTimes[day][i]) ? globalFreeTimes[day][i] : [];
          let busyPeople = (globalBusyTimes[day] && globalBusyTimes[day][i]) ? globalBusyTimes[day][i] : [];
          let cellText = "ç©ºé—²: " + (freePeople.length > 0 ? freePeople.join(', ') : "æ— ") +
                         "\næœ‰è¯¾: " + (busyPeople.length > 0 ? busyPeople.map(item => item.name + " - " + item.course).join(', ') : "æ— ");
          row.push(cellText);
        }
        data.push(row);
      }
      
      // ä½¿ç”¨ SheetJS ç”Ÿæˆ Excel æ–‡ä»¶å¹¶ä¸‹è½½
      var wb = XLSX.utils.book_new();
      var ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Schedule");
      XLSX.writeFile(wb, "schedule.xlsx");
    }
  </script>
</head>
<body>
  <h1>ğŸ“… ç©ºè¯¾è¡¨</h1>
  <div class="week-header">
    <button id="prevWeek">â¬…ï¸ ä¸Šä¸€å‘¨</button>
    <span class="week-title" id="weekTitle">å½“å‰å‘¨</span>
    <button id="nextWeek">ä¸‹ä¸€å‘¨ â¡ï¸</button>
  </div>
  <br>
  <label for="uploadCSV">ğŸ“‚ ä¸Šä¼  CSVï¼š</label>
  <input type="file" id="uploadCSV" accept=".csv">
  <br><br>
  <!-- è¿›åº¦æ¡ -->
  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
  <!-- å¯¼å‡º Excel æŒ‰é’® -->
  <button id="exportExcelBtn">å¯¼å‡º Excel</button>
  <br><br>
  <table id="scheduleTable"></table>

  <!-- è‡ªå®šä¹‰æ¨¡æ€å¼¹çª— -->
  <div id="modalOverlay">
    <div id="modalContent">
      <span id="modalClose">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>
</body>
</html>